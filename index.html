<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ByoKai Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Estilos del Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1f2937;
    }

    ::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }

    /* Estilos de Markdown para el cuerpo del mensaje */
    .markdown-body p {
      margin-bottom: 0.75em;
    }

    .markdown-body pre {
      background: #111827;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin-bottom: 1rem;
      border: 1px solid #374151;
    }

    .markdown-body code {
      font-family: monospace;
      background: #374151;
      padding: 0.2em 0.4em;
      border-radius: 0.25em;
      font-size: 0.9em;
    }

    .markdown-body pre code {
      background: transparent;
      padding: 0;
      color: #e5e7eb;
    }

    .markdown-body a {
      color: #60a5fa;
      text-decoration: underline;
    }

    /* Animación de Typing */
    .typing-dot {
      animation: typing 1.4s infinite ease-in-out both;
    }

    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes typing {

      0%,
      80%,
      100% {
        transform: scale(0);
      }

      40% {
        transform: scale(1);
      }
    }
  </style>
</head>

<body class="bg-gray-900 text-gray-100 font-sans h-screen flex overflow-hidden">

  <aside class="w-64 bg-gray-950 flex flex-col border-r border-gray-800 hidden md:flex">
    <div class="p-4">
      <button onclick="window.createNewChat()"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
        <i class="fas fa-plus"></i> New Chat
      </button>
    </div>
    <div class="flex-1 overflow-y-auto px-2" id="chat-history-list"></div>
    <div class="p-4 border-t border-gray-800 text-xs text-gray-500 text-center">
      Google • Groq • Cerebras • Samba • OpenRouter
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full relative">
    <header class="h-auto py-3 border-b border-gray-800 flex flex-col justify-center px-4 bg-gray-900 z-10 gap-2">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center gap-3 flex-1">
          <button class="md:hidden text-gray-400" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
          <div class="flex flex-col w-full max-w-md">
            <div class="relative">
              <select id="model-selector" onchange="window.changeModel()"
                class="bg-gray-800 text-white text-sm font-bold rounded-t-lg focus:ring-green-500 focus:border-green-500 block w-full p-2 border-gray-700 appearance-none pr-8 cursor-pointer"></select>
              <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-400"><i
                  class="fas fa-chevron-down text-xs"></i></div>
            </div>
            <div
              class="bg-gray-950 border-x border-b border-gray-700 rounded-b-lg px-2 py-1 flex items-center justify-between text-[10px] text-gray-400">
              <span id="model-count-badge" class="text-green-400">Sin modelos validados</span>
              <span id="validation-status" class="text-gray-500 text-right"></span>
            </div>
          </div>
        </div>
        <button onclick="window.openSettings()"
          class="text-gray-400 hover:text-white transition p-2 rounded-full hover:bg-gray-800 ml-2 relative">
          <i class="fas fa-cog fa-lg"></i>
          <span id="settings-dot"
            class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-gray-900"></span>
        </button>
      </div>
    </header>

    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth">
      <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-gray-500 opacity-100">
        <div class="flex gap-4 mb-4 text-5xl">
          <i class="fas fa-brain text-pink-500"></i>
          <i class="fas fa-network-wired text-blue-500 opacity-50 decoration-slice"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-300">ByoKai</h2>
        <div class="mt-4 bg-gray-800/50 border border-gray-700 p-3 rounded text-xs text-gray-400 max-w-sm text-center">
            Esta aplicación centraliza modelos de IA de múltiples proveedores, incluyendo soporte nativo para <strong>Cerebras</strong>.
            <br/>
            Para empezar, introduce tus claves de API en la configuración (⚙️).
        </div>
      </div>
      <div id="messages-list" class="flex flex-col gap-6 max-w-3xl mx-auto w-full pb-4 hidden"></div>
    </div>

    <div class="p-4 bg-gray-900 border-t border-gray-800">
      <div class="max-w-3xl mx-auto relative">
        <textarea id="user-input" rows="1"
          class="w-full bg-gray-800 text-white rounded-xl pl-4 pr-12 py-3 focus:outline-none focus:ring-2 focus:ring-green-600 resize-none overflow-hidden"
          placeholder="Escribe tu mensaje aquí..." oninput="window.autoResize(this)"
          onkeydown="window.handleEnter(event)"></textarea>
        <button onclick="window.sendMessage()" id="send-btn"
          class="absolute right-2 bottom-2 bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </main>

  <div id="settings-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-gray-800 rounded-xl p-6 w-[450px] border border-gray-700 shadow-2xl max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-sliders-h text-green-500"></i>
        Configuración</h3>

      <!-- GOOGLE -->
      <div class="mb-4 bg-gray-900 p-3 rounded-lg border border-gray-700">
        <div class="flex items-center justify-between mb-2"><span class="text-sm font-semibold text-blue-400"><i
              class="fab fa-google"></i> Google AI (Gemini)</span></div>
        <input type="password" id="google-api-key-input"
          class="w-full bg-gray-950 border border-gray-700 rounded p-2 mb-2 text-white text-xs focus:border-blue-500 focus:outline-none"
          placeholder="AIzaSy..." />
        <button onclick="window.runGoogleDiagnostic()" id="google-sync-btn"
          class="w-full py-2 bg-blue-900/50 hover:bg-blue-800 text-blue-200 border border-blue-800 rounded text-xs transition flex items-center justify-center gap-2"><i
            class="fas fa-stethoscope"></i> Diagnóstico Google</button>
        <div id="google-scan-log"
          class="mt-2 h-16 bg-black rounded p-2 overflow-y-auto text-[10px] font-mono border border-gray-800 hidden text-gray-400">
        </div>
      </div>

      <!-- GROQ -->
      <div class="mb-4 bg-gray-900 p-3 rounded-lg border border-gray-700">
        <div class="flex items-center justify-between mb-2"><span class="text-sm font-semibold text-purple-400"><i
              class="fas fa-bolt"></i> GroqCloud</span></div>
        <input type="password" id="groq-api-key-input"
          class="w-full bg-gray-950 border border-gray-700 rounded p-2 mb-2 text-white text-xs focus:border-purple-500 focus:outline-none"
          placeholder="gsk_..." />
        <button onclick="window.runGroqDiagnostic()" id="groq-sync-btn"
          class="w-full py-2 bg-purple-900/50 hover:bg-purple-800 text-purple-200 border border-purple-800 rounded text-xs transition flex items-center justify-center gap-2"><i
            class="fas fa-stethoscope"></i> Diagnóstico Groq</button>
        <div id="groq-scan-log"
          class="mt-2 h-24 bg-black rounded p-2 overflow-y-auto text-[10px] font-mono border border-gray-800 hidden text-gray-400">
        </div>
      </div>

      <!-- CEREBRAS (NUEVO) -->
      <div class="mb-4 bg-gray-900 p-3 rounded-lg border border-gray-700">
        <div class="flex items-center justify-between mb-2"><span class="text-sm font-semibold text-pink-400"><i
              class="fas fa-brain"></i> Cerebras AI</span></div>
        <input type="password" id="cerebras-api-key-input"
          class="w-full bg-gray-950 border border-gray-700 rounded p-2 mb-2 text-white text-xs focus:border-pink-500 focus:outline-none"
          placeholder="csk-..." />
        <button onclick="window.runCerebrasDiagnostic()" id="cerebras-sync-btn"
          class="w-full py-2 bg-pink-900/50 hover:bg-pink-800 text-pink-200 border border-pink-800 rounded text-xs transition flex items-center justify-center gap-2"><i
            class="fas fa-stethoscope"></i> Diagnóstico Cerebras</button>
        <div id="cerebras-scan-log"
          class="mt-2 h-24 bg-black rounded p-2 overflow-y-auto text-[10px] font-mono border border-gray-800 hidden text-gray-400">
        </div>
      </div>

      <!-- SAMBANOVA -->
      <div class="mb-4 bg-gray-900 p-3 rounded-lg border border-gray-700">
        <div class="flex items-center justify-between mb-2"><span class="text-sm font-semibold text-orange-400"><i
              class="fas fa-microchip"></i> SambaNova Cloud</span></div>
        <input type="password" id="samba-api-key-input"
          class="w-full bg-gray-950 border border-gray-700 rounded p-2 mb-2 text-white text-xs focus:border-orange-500 focus:outline-none"
          placeholder="os-..." />
        <button onclick="window.runSambaDiagnostic()" id="samba-sync-btn"
          class="w-full py-2 bg-orange-900/30 hover:bg-orange-800/50 text-orange-200 border border-orange-800 rounded text-xs transition flex items-center justify-center gap-2"><i
            class="fas fa-stethoscope"></i> Diagnóstico SambaNova</button>
        <div id="samba-scan-log"
          class="mt-2 h-24 bg-black rounded p-2 overflow-y-auto text-[10px] font-mono border border-gray-800 hidden text-gray-400">
        </div>
      </div>
      
      <!-- OPENROUTER -->
      <div class="mb-4 bg-gray-900 p-3 rounded-lg border border-gray-700">
        <div class="flex items-center justify-between mb-2"><span class="text-sm font-semibold text-cyan-400"><i
              class="fas fa-share-alt"></i> OpenRouter (CORS OK)</span></div>
        <input type="password" id="openrouter-api-key-input"
          class="w-full bg-gray-950 border border-gray-700 rounded p-2 mb-2 text-white text-xs focus:border-cyan-500 focus:outline-none"
          placeholder="sk-or-v1-..." />
        <button onclick="window.runOpenRouterDiagnostic()" id="openrouter-sync-btn"
          class="w-full py-2 bg-cyan-900/30 hover:bg-cyan-800/50 text-cyan-200 border border-cyan-800 rounded text-xs transition flex items-center justify-center gap-2"><i
            class="fas fa-stethoscope"></i> Diagnóstico OpenRouter</button>
        <div id="openrouter-scan-log"
          class="mt-2 h-24 bg-black rounded p-2 overflow-y-auto text-[10px] font-mono border border-gray-800 hidden text-gray-400">
        </div>
      </div>


      <!-- HUGGING FACE -->
      <div class="mb-4 bg-gray-900 p-3 rounded-lg border border-gray-700">
        <div class="flex items-center justify-between mb-2"><span class="text-sm font-semibold text-yellow-400"><i
              class="fas fa-smile"></i> Hugging Face (Problemas de CORS)</span></div>
        <input type="password" id="hf-api-key-input"
          class="w-full bg-gray-950 border border-gray-700 rounded p-2 mb-2 text-white text-xs focus:border-yellow-500 focus:outline-none"
          placeholder="hf_..." />
        <button onclick="window.runHFDiagnostic()" id="hf-sync-btn"
          class="w-full py-2 bg-yellow-900/30 hover:bg-yellow-800/50 text-yellow-200 border border-yellow-800 rounded text-xs transition flex items-center justify-center gap-2"><i
            class="fas fa-stethoscope"></i> Diagnóstico Hugging Face (Solo si usa Proxy)</button>
        <div id="hf-scan-log"
          class="mt-2 h-24 bg-black rounded p-2 overflow-y-auto text-[10px] font-mono border border-gray-800 hidden text-gray-400">
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-4 border-t border-gray-700 pt-4">
        <button onclick="window.closeSettings()"
          class="px-4 py-2 text-gray-300 hover:bg-gray-700 rounded transition text-sm">Cerrar</button>
        <button onclick="window.saveSettings()"
          class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition text-sm">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // ARQUITECTURA: Catálogo V21 - Cerebras Added
    const SAMBANOVA_MODELS = [
      "DeepSeek-R1", "DeepSeek-R1-Distill-Llama-70B", "DeepSeek-V3-0324", 
      "Meta-Llama-3.3-70B-Instruct", "Meta-Llama-3.1-8B-Instruct", 
      "Llama-4-Maverick-17B-128E-Instruct", "gpt-oss-120b", "Qwen3-32B", 
      "Llama-3.3-Swallow-70B-Instruct-v0.4"
    ];

    // MODELOS CEREBRAS ESPECÍFICOS SOLICITADOS
    const CEREBRAS_SPECIFIC_MODELS = [
        "gpt-oss-120b", 
        "llama3.1-8b", 
        "qwen-3-235b-a22b-instruct-2507", 
        "qwen-3-32b", 
        "zai-glm-4.6"
    ];

    const APP_STORAGE_KEY = "ai_chat_v21_cerebras_edition";
    
    // Listas de modelos validados
    var googleModels = [], groqModels = [], sambaModels = [], hfModels = [], openrouterModels = [], cerebrasModels = [];
    
    var state = {
      googleApiKey: "", groqApiKey: "", sambaApiKey: "", hfApiKey: "", openrouterApiKey: "", cerebrasApiKey: "",
      currentModel: null, chats: [], currentChatId: null, isGenerating: false
    };

    // HF Models Catalog
    var HF_CHAT_MODELS = [
      "mistralai/Mistral-7B-Instruct-v0.3", "mistralai/Mixtral-8x7B-Instruct-v0.1", 
      "meta-llama/Llama-3.1-8B-Instruct", "google/gemma-2-9b-it", 
      "microsoft/Phi-3-mini-4k-instruct"
    ];

    marked.setOptions({ breaks: true });

    window.onload = function () {
      window.loadFromLocalStorage(); 
      window.updateSettingsDot(); 
      window.initModelSelector(); 
      window.renderChatHistory();
      if (state.chats.length > 0) {
        if (!state.chats.find(c => c.id === state.currentChatId)) state.currentChatId = state.chats[0].id;
        window.loadChat(state.currentChatId);
      } else window.createNewChat(false);
    };

    window.saveToLocalStorage = function () {
      localStorage.setItem(APP_STORAGE_KEY, JSON.stringify({
        keys: { 
            google: state.googleApiKey, groq: state.groqApiKey, samba: state.sambaApiKey, hf: state.hfApiKey, 
            openrouter: state.openrouterApiKey, cerebras: state.cerebrasApiKey 
        },
        currentModel: state.currentModel, chats: state.chats,
        cachedModels: { 
            google: googleModels, groq: groqModels, samba: sambaModels, hf: hfModels, 
            openrouter: openrouterModels, cerebras: cerebrasModels
        }
      }));
    }

    window.loadFromLocalStorage = function () {
      const raw = localStorage.getItem(APP_STORAGE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        state.googleApiKey = data.keys?.google || ""; 
        state.groqApiKey = data.keys?.groq || ""; 
        state.sambaApiKey = data.keys?.samba || ""; 
        state.hfApiKey = data.keys?.hf || "";
        state.openrouterApiKey = data.keys?.openrouter || ""; 
        state.cerebrasApiKey = data.keys?.cerebras || "";
        
        state.currentModel = data.currentModel || null; 
        state.chats = data.chats || [];
        
        if (data.cachedModels) {
          googleModels = data.cachedModels.google || [];
          groqModels = data.cachedModels.groq || [];
          sambaModels = data.cachedModels.samba || [];
          hfModels = data.cachedModels.hf || [];
          openrouterModels = data.cachedModels.openrouter || [];
          cerebrasModels = data.cachedModels.cerebras || [];
        }
      } catch (e) { }
    }

    const delay = ms => new Promise(res => setTimeout(res, ms));

    // UTILS: Sanitización
    window.escapeHtml = function (text) {
      if (!text) return text;
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // --- DIAGNÓSTICOS ---

    window.runGoogleDiagnostic = async function () {
      const apiKey = document.getElementById("google-api-key-input").value.trim();
      const log = document.getElementById("google-scan-log");
      const btn = document.getElementById("google-sync-btn");
      if (!apiKey) return alert("Falta API Key de Google");
      state.googleApiKey = apiKey; window.saveToLocalStorage();
      btn.disabled = true; btn.innerText = "Probando..."; log.classList.remove("hidden"); log.innerHTML = ">> Google: Iniciando...";
      let valid = [];
      try {
        const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
        if (!listResp.ok) throw new Error("Key inválida / API Error");
        const listData = await listResp.json();
        const rawModels = (listData.models || []).filter(m => m.supportedGenerationMethods?.includes("generateContent"));
        for (const m of rawModels) {
          const modelId = m.name.replace("models/", "");
          log.innerHTML += `<div class="text-blue-300">Test: ${modelId}...</div>`; log.scrollTop = log.scrollHeight;
          await delay(250);
          try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`, {
              method: "POST", headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ contents: [{ parts: [{ text: "hi" }] }], generationConfig: { maxOutputTokens: 1 } })
            });
            if (r.ok) { valid.push({ id: modelId, name: m.displayName || modelId, provider: "google" }); log.innerHTML += `<div class="text-green-500 pl-2">✔ OK</div>`; }
          } catch (e) { }
        }
        googleModels = valid; log.innerHTML += `<div class="text-white mt-2">>> Total: ${valid.length}</div>`;
      } catch (e) { log.innerHTML += `<div class="text-red-500">Error: ${e.message}</div>`; }
      window.saveToLocalStorage(); window.initModelSelector(); window.updateSettingsDot(); btn.disabled = false; btn.innerHTML = '<i class="fas fa-stethoscope"></i> Diagnóstico Google';
    }

    window.runGroqDiagnostic = async function () {
      const apiKey = document.getElementById("groq-api-key-input").value.trim();
      const log = document.getElementById("groq-scan-log");
      const btn = document.getElementById("groq-sync-btn");
      if (!apiKey) return alert("Falta API Key de Groq");
      state.groqApiKey = apiKey; window.saveToLocalStorage();

      btn.disabled = true; btn.innerText = "Auditando...";
      log.classList.remove("hidden"); log.innerHTML = ">> Groq: Obteniendo lista...";

      let valid = [];
      try {
        const resp = await fetch("https://api.groq.com/openai/v1/models", { headers: { Authorization: `Bearer ${apiKey}` } });
        if (!resp.ok) {
            const errorData = await resp.json();
            throw new Error(errorData.error?.message || `Error de conexión: ${resp.status}`);
        }
        const data = await resp.json();
        const rawList = data.data || [];
        rawList.forEach(m => {
            if (!m.id.includes("whisper")) {
                valid.push({ id: m.id, name: m.id, provider: "groq" });
            }
        });

        groqModels = valid;
        log.innerHTML += `<div class="text-green-400 mt-2">>> Chat Ready: ${valid.length}</div>`;
      } catch (e) { log.innerHTML += `<div class="text-red-500">Error: ${e.message}</div>`; }
      window.saveToLocalStorage(); window.initModelSelector(); window.updateSettingsDot(); btn.disabled = false; btn.innerHTML = '<i class="fas fa-stethoscope"></i> Diagnóstico Groq';
    }

    // --- CEREBRAS DIAGNOSTIC (NUEVO) ---
    window.runCerebrasDiagnostic = async function () {
        const apiKey = document.getElementById("cerebras-api-key-input").value.trim();
        const log = document.getElementById("cerebras-scan-log");
        const btn = document.getElementById("cerebras-sync-btn");

        if (!apiKey) return alert("Falta API Key de Cerebras");
        state.cerebrasApiKey = apiKey; window.saveToLocalStorage();

        btn.disabled = true; btn.innerText = "Conectando Cerebras...";
        log.classList.remove("hidden"); log.innerHTML = ">> Cerebras: Verificando modelos solicitados...";

        let valid = [];
        const cerebrasUrl = "https://api.cerebras.ai/v1/chat/completions";

        // Probar los modelos específicos solicitados uno por uno
        for (const modelId of CEREBRAS_SPECIFIC_MODELS) {
            log.innerHTML += `<div class="text-pink-300 mt-1">Ping: ${modelId}...</div>`; log.scrollTop = log.scrollHeight;
            try {
                // Realizar una llamada de prueba mínima
                const resp = await fetch(cerebrasUrl, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: modelId,
                        messages: [{ role: "user", content: "hi" }],
                        max_tokens: 1,
                        stream: false
                    })
                });

                if (resp.ok) {
                    valid.push({ id: modelId, name: modelId, provider: "cerebras" });
                    log.innerHTML += `<div class="text-green-500 pl-4">✔ Activo</div>`;
                } else {
                    const errText = await resp.json().catch(() => ({}));
                    const errMsg = errText.error?.message || resp.statusText;
                    // Aunque falle, si el usuario los solicitó específicamente, los añadimos con una advertencia visual en el log, 
                    // pero para la lista final solo añadimos los que respondan O forzamos si es un error de parámetros pero no de auth.
                    // Para seguridad, solo agregamos los que funcionan, PERO como son modelos 'custom', puede que la API pública no los liste.
                    // Vamos a confiar en la respuesta de la API.
                    log.innerHTML += `<div class="text-red-400 pl-4">Err: ${errMsg.substring(0,30)}...</div>`;
                }
            } catch (e) {
                log.innerHTML += `<div class="text-red-500 pl-4">Net Err: ${e.message}</div>`;
            }
            await delay(300);
        }

        // Si la lista está vacía (quizás todos fallaron), intentamos obtener la lista genérica por si acaso
        if (valid.length === 0) {
            log.innerHTML += `<div class="text-gray-400 mt-1">Intentando lista genérica...</div>`;
            try {
                 const resp = await fetch("https://api.cerebras.ai/v1/models", { headers: { Authorization: `Bearer ${apiKey}` } });
                 const data = await resp.json();
                 if (data.data) {
                     data.data.forEach(m => valid.push({ id: m.id, name: m.id, provider: "cerebras" }));
                     log.innerHTML += `<div class="text-green-400">>> Encontrados: ${valid.length} genéricos</div>`;
                 }
            } catch(e) {}
        }

        // Fallback: Si el usuario insiste en estos modelos y la API falla solo en la validación pero la Key es correcta,
        // podríamos forzarlos. Por ahora, solo guardamos los validados.
        
        // **MODIFICACIÓN**: Dado que los modelos solicitados (gpt-oss-120b, etc.) pueden ser alias internos o beta,
        // si la validación falla por "model not found" no los agregamos. Pero si valid.length es 0 y tenemos key,
        // agregamos la lista hardcodeada para que el usuario pueda intentar usarlos igual.
        if (valid.length === 0 && apiKey.startsWith("csk-")) {
            log.innerHTML += `<div class="text-yellow-400 mt-2">>> Advertencia: No se validaron modelos. Agregando lista solicitada forzosamente.</div>`;
            CEREBRAS_SPECIFIC_MODELS.forEach(m => valid.push({ id: m, name: m + " (Force)", provider: "cerebras" }));
        }

        cerebrasModels = valid;
        log.innerHTML += `<div class="text-white mt-2 font-bold">>> Total Cerebras: ${valid.length}</div>`;
        
        window.saveToLocalStorage(); window.initModelSelector(); window.updateSettingsDot();
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-stethoscope"></i> Diagnóstico Cerebras';
    }

    window.runSambaDiagnostic = async function () {
      const apiKey = document.getElementById("samba-api-key-input").value.trim();
      const log = document.getElementById("samba-scan-log");
      const btn = document.getElementById("samba-sync-btn");

      if (!apiKey) return alert("Falta API Key de SambaNova");
      state.sambaApiKey = apiKey; window.saveToLocalStorage();

      btn.disabled = true; btn.innerText = "Verificando...";
      log.classList.remove("hidden"); log.innerHTML = ">> SambaNova: Conectando...";

      let valid = [];
      const sambaUrl = "https://api.sambanova.ai/v1/chat/completions";

      for (const modelId of SAMBANOVA_MODELS) {
        let shortName = modelId;
        shortName = shortName.replace(/^Meta-/, "").replace(/-Instruct.*/, "").replace(/-Distill/, "");
        if (shortName.includes("DeepSeek")) shortName = shortName.replace("Llama-", "");

        log.innerHTML += `<div class="text-orange-200 mt-1">Ping: ${shortName}...</div>`; log.scrollTop = log.scrollHeight;

        try {
          const resp = await fetch(sambaUrl, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json"
            },
            body: JSON.stringify({ model: modelId, messages: [{ role: "user", content: "hi" }], max_tokens: 1, stream: false })
          });

          if (resp.ok) {
            valid.push({ id: modelId, name: modelId, provider: "samba" });
            log.innerHTML += `<div class="text-green-500 pl-4">✔ Activo</div>`;
          } else {
            const errText = await resp.text();
            let msg = `Status: ${resp.status}`;
            try {
              const json = JSON.parse(errText);
              if (json.error && json.error.message) msg = json.error.message;
              else if (json.message) msg = json.message;
            } catch (e) {
              if (errText.length < 50 && errText.length > 0) msg = errText;
            }
            log.innerHTML += `<div class="text-red-500 pl-4">Err: ${msg}</div>`;
          }
        } catch (e) {
          log.innerHTML += `<div class="text-red-500 pl-4">Net: ${e.message}</div>`;
        }
        await delay(500); 
      }
      sambaModels = valid; window.saveToLocalStorage(); window.initModelSelector(); window.updateSettingsDot();
      log.innerHTML += `<div class="text-white font-bold mt-2">>> Disponibles: ${valid.length}</div>`;
      btn.disabled = false; btn.innerHTML = '<i class="fas fa-stethoscope"></i> Diagnóstico SambaNova';
    }

    window.runOpenRouterDiagnostic = async function () {
        const apiKey = document.getElementById("openrouter-api-key-input").value.trim();
        const log = document.getElementById("openrouter-scan-log");
        const btn = document.getElementById("openrouter-sync-btn");

        if (!apiKey) return alert("Falta API Key de OpenRouter");
        state.openrouterApiKey = apiKey; window.saveToLocalStorage();

        btn.disabled = true; btn.innerText = "Auditando modelos...";
        log.classList.remove("hidden"); log.innerHTML = ">> OpenRouter: Conectando...";

        let valid = [];
        const openrouterUrl = "https://openrouter.ai/api/v1/models";

        try {
            const resp = await fetch(openrouterUrl, {
                headers: { "Authorization": `Bearer ${apiKey}` }
            });

            if (!resp.ok) {
                const errorData = await resp.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `Error de conexión: ${resp.status}`);
            }

            const data = await resp.json();
            const rawList = data.data || [];

            valid = rawList
                .filter(m => m.id.includes("llama") || m.id.includes("mixtral") || m.id.includes("mistral") || m.id.includes("gemma") || m.id.includes("gpt"))
                .map(m => ({ id: m.id, name: m.id.split("/").pop(), provider: "openrouter" }));

            openrouterModels = valid;
            log.innerHTML += `<div class="text-green-400 mt-2">>> Modelos Chat Ready: ${valid.length}</div>`;

        } catch (e) {
            log.innerHTML += `<div class="text-red-500">Error: ${e.message}</div>`;
        }

        window.saveToLocalStorage();
        window.initModelSelector();
        window.updateSettingsDot();
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-stethoscope"></i> Diagnóstico OpenRouter';
    }

    window.runHFDiagnostic = async function () {
      const apiKey = document.getElementById("hf-api-key-input").value.trim();
      const log = document.getElementById("hf-scan-log");
      const btn = document.getElementById("hf-sync-btn");

      if (!apiKey) return alert("Falta API Key de Hugging Face");
      state.hfApiKey = apiKey; window.saveToLocalStorage();

      btn.disabled = true; btn.innerText = "Verificando...";
      log.classList.remove("hidden"); log.innerHTML = ">> Hugging Face: Probando modelos...";
      
      let valid = [];
      for (const modelId of HF_CHAT_MODELS) {
        log.innerHTML += `<div class="text-yellow-200 mt-1">Ping: ${modelId.split("/").pop()}...</div>`; log.scrollTop = log.scrollHeight;
        try {
          const resp = await fetch(`https://api-inference.huggingface.co/models/${modelId}`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
            body: JSON.stringify({ inputs: "hi", parameters: { max_new_tokens: 1 } })
          });
          if (resp.ok) {
            valid.push({ id: modelId, name: modelId.split("/").pop(), provider: "hf" });
            log.innerHTML += `<div class="text-green-500 pl-4">✔ Activo</div>`;
          } else {
             log.innerHTML += `<div class="text-red-500 pl-4">Err: ${resp.status}</div>`;
          }
        } catch (e) {
          log.innerHTML += `<div class="text-red-500 pl-4">Net: Failed (CORS?)</div>`;
        }
        await delay(500);
      }
      hfModels = valid; window.saveToLocalStorage(); window.initModelSelector(); window.updateSettingsDot();
      log.innerHTML += `<div class="text-white font-bold mt-2">>> Disponibles: ${valid.length}</div>`;
      btn.disabled = false; btn.innerHTML = '<i class="fas fa-stethoscope"></i> Diagnóstico HF';
    }

    // --- GESTIÓN DE MODELOS ---

    window.ensureValidCurrentModel = function () {
      const m = window.getCurrentModel(); if (m) return;
      if (googleModels.length > 0) state.currentModel = { provider: "google", id: googleModels[0].id };
      else if (groqModels.length > 0) state.currentModel = { provider: "groq", id: groqModels[0].id };
      else if (cerebrasModels.length > 0) state.currentModel = { provider: "cerebras", id: cerebrasModels[0].id }; // Priority
      else if (sambaModels.length > 0) state.currentModel = { provider: "samba", id: sambaModels[0].id };
      else if (openrouterModels.length > 0) state.currentModel = { provider: "openrouter", id: openrouterModels[0].id };
      else if (hfModels.length > 0) state.currentModel = { provider: "hf", id: hfModels[0].id };
      else state.currentModel = null;
    }
    
    window.getCurrentModel = function () {
      if (!state.currentModel) return null;
      let list;
      if (state.currentModel.provider === "google") list = googleModels;
      else if (state.currentModel.provider === "groq") list = groqModels;
      else if (state.currentModel.provider === "cerebras") list = cerebrasModels;
      else if (state.currentModel.provider === "samba") list = sambaModels;
      else if (state.currentModel.provider === "openrouter") list = openrouterModels;
      else list = hfModels;

      return list.find((m) => m.id === state.currentModel.id) || null;
    }
    
    window.initModelSelector = function () {
      window.ensureValidCurrentModel();
      const selector = document.getElementById("model-selector");
      const badge = document.getElementById("model-count-badge");
      const statusBadge = document.getElementById("validation-status");

      const total = googleModels.length + groqModels.length + sambaModels.length + hfModels.length + openrouterModels.length + cerebrasModels.length;
      
      if (total === 0) {
        selector.innerHTML = '<option value="" disabled selected>Sin modelos. Ejecuta diagnósticos ⚙️</option>'; 
        selector.disabled = true; 
        badge.textContent = "0 modelos"; 
        statusBadge.textContent = "Sin acceso a APIs";
        return;
      }

      selector.disabled = false;
      let html = "";
      
      if (googleModels.length) { html += '<optgroup label="Google AI">'; googleModels.forEach(m => html += `<option value="google::${m.id}" ${window.isSelected("google", m.id)}>${m.name}</option>`); html += "</optgroup>"; }
      if (groqModels.length) { html += '<optgroup label="GroqCloud">'; groqModels.forEach(m => html += `<option value="groq::${m.id}" ${window.isSelected("groq", m.id)}>${m.name}</option>`); html += "</optgroup>"; }
      
      // CEREBRAS GROUP
      if (cerebrasModels.length) { html += '<optgroup label="Cerebras AI">'; cerebrasModels.forEach(m => html += `<option value="cerebras::${m.id}" ${window.isSelected("cerebras", m.id)}>${m.name}</option>`); html += "</optgroup>"; }
      
      if (sambaModels.length) {
        html += '<optgroup label="SambaNova">';
        sambaModels.forEach(m => {
          let s = m.name;
          s = s.replace(/^Meta-/, "").replace(/-Instruct.*/, "").replace(/-Distill/, "");
          html += `<option value="samba::${m.id}" ${window.isSelected("samba", m.id)}>${s}</option>`
        });
        html += "</optgroup>";
      }
      
      if (openrouterModels.length) { html += '<optgroup label="OpenRouter">'; openrouterModels.forEach(m => html += `<option value="openrouter::${m.id}" ${window.isSelected("openrouter", m.id)}>${m.name}</option>`); html += "</optgroup>"; }
      if (hfModels.length) { html += '<optgroup label="Hugging Face">'; hfModels.forEach(m => html += `<option value="hf::${m.id}" ${window.isSelected("hf", m.id)}>${m.name}</option>`); html += "</optgroup>"; }
      
      selector.innerHTML = html; 
      badge.textContent = `G: ${googleModels.length} • Cer: ${cerebrasModels.length} • Groq: ${groqModels.length} • Samba: ${sambaModels.length} • OR: ${openrouterModels.length}`;

      const current = window.getCurrentModel();
      statusBadge.className = 'text-gray-500 text-right';
      if (current) {
         statusBadge.textContent = `${current.provider.toUpperCase()} (${current.id.split('/').pop().substring(0, 15)}...)`;
         statusBadge.classList.remove("text-gray-500");
         if (current.provider === "google") statusBadge.classList.add("text-blue-400");
         else if (current.provider === "groq") statusBadge.classList.add("text-purple-400");
         else if (current.provider === "cerebras") statusBadge.classList.add("text-pink-400"); // PINK FOR CEREBRAS
         else if (current.provider === "samba") statusBadge.classList.add("text-orange-400");
         else if (current.provider === "openrouter") statusBadge.classList.add("text-cyan-400");
         else if (current.provider === "hf") statusBadge.classList.add("text-yellow-400");
      } else {
         statusBadge.textContent = "Selecciona un modelo";
      }
    }
    
    window.isSelected = function (prov, id) { return (state.currentModel?.provider === prov && state.currentModel?.id === id) ? "selected" : ""; }
    window.changeModel = function () {
      const v = document.getElementById("model-selector").value; 
      if (!v) return;
      const [p, i] = v.split("::"); 
      state.currentModel = { provider: p, id: i }; 
      window.saveToLocalStorage();
      window.initModelSelector(); 
    }

    // --- CALL API WRAPPERS ---
    
    window.callGoogle = async function (model, messages) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model.id}:generateContent?key=${state.googleApiKey}`;
      const contents = messages.map(m => ({ role: m.role === "user" ? "user" : "model", parts: [{ text: m.text }] }));
      const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents }) });
      const data = await res.json(); 
      if (!res.ok) throw new Error(data.error?.message || `Error Google: ${res.status}`);
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "Vacio";
    }

    window.callGroq = async function (model, messages) { return window.callOpenAIFormat("https://api.groq.com/openai/v1/chat/completions", state.groqApiKey, model.id, messages); }
    window.callSamba = async function (model, messages) { return window.callOpenAIFormat("https://api.sambanova.ai/v1/chat/completions", state.sambaApiKey, model.id, messages); }
    window.callOpenRouter = async function (model, messages) { return window.callOpenAIFormat("https://openrouter.ai/api/v1/chat/completions", state.openrouterApiKey, model.id, messages); }
    
    // NUEVA LLAMADA: CEREBRAS
    window.callCerebras = async function (model, messages) { 
        return window.callOpenAIFormat("https://api.cerebras.ai/v1/chat/completions", state.cerebrasApiKey, model.id, messages); 
    }

    window.callHF = async function (model, messages) {
      const lastMessage = messages[messages.length - 1].text; 
      
      const res = await fetch(`https://api-inference.huggingface.co/models/${model.id}`,
        { method: "POST", headers: { "Authorization": `Bearer ${state.hfApiKey}`, "Content-Type": "application/json" }, body: JSON.stringify({ inputs: lastMessage }) });

      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error?.message || `Error HF: ${JSON.stringify(data).substring(0, 100)}...`);
      }
      
      const generatedText = data?.[0]?.generated_text;
      
      if (generatedText && generatedText.startsWith(lastMessage)) {
        return generatedText.substring(lastMessage.length).trim();
      }
      return generatedText || "Vacio";
    }

    window.callOpenAIFormat = async function (endpoint, key, modelId, messages) {
      const formatted = messages.map(m => ({ role: m.role === "user" ? "user" : "assistant", content: m.text }));
      
      const res = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${key}`
        },
        body: JSON.stringify({ model: modelId, messages: formatted, max_tokens: 4096 })
      });

      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error?.message || `Error API: ${res.status} - ${modelId}`);
      }
      return data.choices?.[0]?.message?.content || "Empty";
    }

    // --- LÓGICA DE CHAT Y RENDERIZADO ---

    window.createNewChat = function (r = true) { const c = { id: Date.now().toString(), title: "New Chat", messages: [] }; state.chats.unshift(c); state.currentChatId = c.id; window.saveToLocalStorage(); if (r) { window.renderChatHistory(); window.renderMessages(); } }
    window.loadChat = function (id) { state.currentChatId = id; window.renderChatHistory(); window.renderMessages(); }
    window.deleteChat = function (e, id) { e.stopPropagation(); if (confirm("¿Borrar chat?")) { state.chats = state.chats.filter(c => c.id !== id); state.currentChatId = state.chats.length ? state.chats[0].id : null; if (!state.currentChatId) window.createNewChat(false); window.saveToLocalStorage(); window.renderChatHistory(); window.renderMessages(); } }
    
    window.renderChatHistory = function () {
      document.getElementById("chat-history-list").innerHTML = state.chats.map(c => `
        <div onclick="window.loadChat('${c.id}')" class="group flex items-center justify-between p-3 rounded-lg cursor-pointer mb-1 transition ${c.id === state.currentChatId ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-900'}">
          <div class="flex items-center gap-3 overflow-hidden"><i class="fas fa-message text-xs"></i><span class="text-sm truncate">${window.escapeHtml(c.title)}</span></div>
          <button onclick="window.deleteChat(event,'${c.id}')" class="opacity-0 group-hover:opacity-100 hover:text-red-400"><i class="fas fa-trash text-xs"></i></button>
        </div>`).join("");
    }

    window.renderMessages = function () {
      const c = state.chats.find(x => x.id === state.currentChatId); 
      const cont = document.getElementById("messages-list"); 
      const wel = document.getElementById("welcome-screen");
      
      if (!c || c.messages.length === 0) { 
        cont.classList.add("hidden"); 
        wel.classList.remove("hidden"); 
        return; 
      }
      
      wel.classList.add("hidden"); 
      cont.classList.remove("hidden");
      
      cont.innerHTML = c.messages.map(m => {
        const u = m.role === "user";
        const content = u
          ? `<p class="whitespace-pre-wrap">${window.escapeHtml(m.text)}</p>`
          : DOMPurify.sanitize(marked.parse(m.text));

        return `<div class="flex w-full ${u ? "justify-end" : "justify-start"}"><div class="flex gap-3 max-w-[85%] ${u ? "flex-row-reverse" : "flex-row"}">
        <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${u ? "bg-gray-700" : "bg-green-600"}"><i class="fas ${u ? "fa-user" : "fa-robot"} text-white text-sm"></i></div>
        <div class="px-4 py-3 rounded-2xl ${u ? "bg-gray-800 text-white" : "bg-transparent"} markdown-body text-sm leading-relaxed overflow-hidden">${content}</div></div></div>`;
      }).join("");
      window.scrollToBottom();
    }

    window.sendMessage = async function () {
      if (state.isGenerating) return; 
      const m = window.getCurrentModel(); 
      if (!m) return alert("Modelo no válido. Configura las APIs ⚙️");
      
      const inp = document.getElementById("user-input"); 
      const txt = inp.value.trim(); 
      if (!txt) return;
      
      const c = state.chats.find(x => x.id === state.currentChatId); 
      
      if (c.messages.length === 0) { 
        c.title = txt.substring(0, 30) + (txt.length > 30 ? "..." : ""); 
        window.renderChatHistory(); 
      }
      
      c.messages.push({ role: "user", text: txt }); 
      inp.value = ""; 
      inp.style.height = "auto"; 
      window.renderMessages();
      
      state.isGenerating = true; 
      document.getElementById("send-btn").disabled = true;
      
      const d = document.createElement("div"); 
      d.id = "typing"; 
      d.className = "pl-11"; 
      d.innerHTML = `<div class="px-4 py-2 flex gap-1"><div class="typing-dot w-2 h-2 bg-gray-500 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-500 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-500 rounded-full"></div></div>`;
      document.getElementById("messages-list").appendChild(d); 
      window.scrollToBottom();
      
      try {
        const ctx = c.messages.slice(-8); 
        let r = "";
        
        if (m.provider === "google") r = await window.callGoogle(m, ctx);
        else if (m.provider === "groq") r = await window.callGroq(m, ctx);
        else if (m.provider === "cerebras") r = await window.callCerebras(m, ctx); // <-- RUTA CEREBRAS
        else if (m.provider === "samba") r = await window.callSamba(m, ctx);
        else if (m.provider === "openrouter") r = await window.callOpenRouter(m, ctx); 
        else if (m.provider === "hf") r = await window.callHF(m, ctx);
        
        c.messages.push({ role: "ai", text: r }); 
        window.saveToLocalStorage();
      } catch (e) { 
        console.error("AI Generation Error:", e);
        c.messages.push({ role: "ai", text: `⚠️ Error de API (${m.provider}): ${e.message}` }); 
      }
      
      state.isGenerating = false; 
      if (document.getElementById("typing")) document.getElementById("typing").remove(); 
      window.renderMessages(); 
      document.getElementById("send-btn").disabled = false;
      inp.focus(); 
    }
    
    window.scrollToBottom = function () { const c = document.getElementById("chat-container"); c.scrollTop = c.scrollHeight; }
    window.autoResize = function (t) { t.style.height = "auto"; t.style.height = Math.min(t.scrollHeight, 200) + "px"; }
    window.handleEnter = function (e) { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); window.sendMessage(); } }
    
    window.openSettings = function () {
      document.getElementById("google-api-key-input").value = state.googleApiKey;
      document.getElementById("groq-api-key-input").value = state.groqApiKey;
      document.getElementById("cerebras-api-key-input").value = state.cerebrasApiKey; // <-- SET CEREBRAS INPUT
      document.getElementById("samba-api-key-input").value = state.sambaApiKey;
      document.getElementById("hf-api-key-input").value = state.hfApiKey;
      document.getElementById("openrouter-api-key-input").value = state.openrouterApiKey;
      
      document.getElementById("settings-modal").classList.remove("hidden");
      document.getElementById("settings-modal").classList.add("flex");
    }
    window.closeSettings = function () { 
        document.getElementById("google-scan-log").classList.add("hidden");
        document.getElementById("groq-scan-log").classList.add("hidden");
        document.getElementById("cerebras-scan-log").classList.add("hidden"); // <-- HIDE LOG
        document.getElementById("samba-scan-log").classList.add("hidden");
        document.getElementById("hf-scan-log").classList.add("hidden");
        document.getElementById("openrouter-scan-log").classList.add("hidden");
        
        document.getElementById("settings-modal").classList.add("hidden"); 
        document.getElementById("settings-modal").classList.remove("flex"); 
    }
    
    window.saveSettings = function () {
      state.googleApiKey = document.getElementById("google-api-key-input").value.trim();
      state.groqApiKey = document.getElementById("groq-api-key-input").value.trim();
      state.cerebrasApiKey = document.getElementById("cerebras-api-key-input").value.trim(); // <-- SAVE KEY
      state.sambaApiKey = document.getElementById("samba-api-key-input").value.trim();
      state.hfApiKey = document.getElementById("hf-api-key-input").value.trim();
      state.openrouterApiKey = document.getElementById("openrouter-api-key-input").value.trim();
      
      window.saveToLocalStorage(); 
      window.updateSettingsDot(); 
      window.closeSettings();
    }
    
    window.updateSettingsDot = function () { 
      const d = document.getElementById("settings-dot"); 
      if (!state.googleApiKey && !state.groqApiKey && !state.cerebrasApiKey && !state.sambaApiKey && !state.openrouterApiKey) {
        d.classList.remove("hidden"); 
      } else {
        d.classList.add("hidden"); 
      }
    }
    
    window.toggleSidebar = function () { const s = document.querySelector("aside"); s.classList.toggle("hidden"); s.classList.toggle("absolute"); s.classList.toggle("z-20"); s.classList.toggle("h-full"); }
  </script>
</body>

</html>
